<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asburium VPN</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<link rel="stylesheet" href="/static/css/main.css">
</head>

<body>

<div class="drawer-overlay" id="overlay" onclick="closeDrawer()"></div>

<div class="drawer" id="drawer">
  <div class="user">
    <img id="avatar">
    <div>
      <strong id="username">User</strong><br>
      <small>ID: <span id="userid"></span></small>
    </div>
  </div>

  <div class="balance-card">
    <div>–ú–æ–π –±–∞–ª–∞–Ω—Å</div>
    <strong>üí∞ 0 ‚ÇΩ</strong>
    <button onclick="openTab('topup'); closeDrawer()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
  </div>

  <div class="item">üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
  <div class="item">üéÅ –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ (+50 ‚ÇΩ)</div>
  <div class="item">üìò –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</div>
  <div class="item">üè∑ –ü—Ä–æ–º–æ–∫–æ–¥</div>
  <div class="item" style="color:#22c55e">üõü –ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
</div>

<header class="header">
  <div class="header-bar">
    <div class="menu-btn" onclick="openDrawer()">‚ò∞</div>
    <div class="balance">
      üí∞ <span>50 ‚ÇΩ</span>
      <div class="plus" onclick="openTab('topup')">+</div>
    </div>
  </div>
</header>

<main class="main">

  <div id="vpn" class="view active">
   <div class="card" id="vpnCard">
    </div>
  </div>

  <div id="topup" class="view">
    <div class="card">
      <div class="topup-title">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</div>
      <div class="topup-sub">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –∏ —Å—É–º–º—É</div>

      <div class="pay-methods">
        <div class="pay-method active">üí∞<span>–°–ë–ü</span></div>
        <div class="pay-method">üí≥<span>–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</span></div>
      </div>

      <div class="amounts-title">–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</div>

      <div class="amount active">
        <strong>150 ‚ÇΩ</strong>
        <small>–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ 1 –º–µ—Å—è—Ü</small>
      </div>
      <div class="amount">
        <strong>300 ‚ÇΩ</strong>
        <small>–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ 2 –º–µ—Å—è—Ü–∞</small>
      </div>
      <div class="amount">
        <strong>450 ‚ÇΩ</strong>
        <small>–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ 3 –º–µ—Å—è—Ü–∞</small>
      </div>

<button class="primary-btn" onclick="createPayment()">
  –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ
</button>
    </div>
  </div>

  <div id="help" class="view">
    <div class="card">
      <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</h3>
      <p>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é VPN</p>
    </div>
  </div>

</main>

<footer class="footer">
  <div class="footer-btn active" onclick="openTab('topup')">
    <span>üí∞</span>–ü–æ–ø–æ–ª–Ω–∏—Ç—å
  </div>

  <div class="footer-core" onclick="openTab('vpn')">
    VPN
  </div>

  <div class="footer-btn" onclick="openTab('help')">
    <span>üìò</span>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
  </div>
</footer>

<script>
/* ======================================================
   ASBURIUM VPN ‚Äî MINI APP (FINAL STABLE VERSION)
====================================================== */

const tg = window.Telegram.WebApp;

console.log("initData:", tg.initData);
console.log("initDataUnsafe:", tg.initDataUnsafe);

/* ================== STATE ================== */
const state = {
  user: null,
  vpnList: [],
  activeTab: "vpn",
  paymentMethod: "sbp",
  amount: 150,
  ready: false,
};

/* ================== HELPERS ================== */
function qs(id) {
  return document.getElementById(id);
}

function showAlert(text) {
  if (tg?.showAlert) tg.showAlert(text);
  else alert(text);
}

/* ================== WAIT TELEGRAM ================== */
async function waitForTelegramInit() {
  while (!tg.initData || tg.initData.length === 0) {
    await new Promise(r => setTimeout(r, 200));
  }
}

/* ================== API ================== */
async function api(path, options = {}) {
  const res = await fetch(path, {
    ...options,
    headers: {
      ...(options.headers || {}),
      "X-Telegram-Init-Data": tg.initData,
    },
  });

  if (!res.ok) {
    const text = await res.text();
    throw new Error(text || "API error");
  }

  return res.json();
}

/* ================== USER ================== */
async function loadMe() {
  state.user = await api("/api/me");

  // Telegram user info
  qs("username").innerText =
    tg.initDataUnsafe?.user?.first_name || "User";

  qs("userid").innerText =
    tg.initDataUnsafe?.user?.id || "";

  qs("avatar").src =
    tg.initDataUnsafe?.user?.photo_url || "";

  // Balance
  document.querySelectorAll(".balance span").forEach(el => {
    el.innerText = `${state.user.balance} ‚ÇΩ`;
  });
}

/* ================== VPN ================== */
async function loadVpnList() {
  const data = await api("/api/vpn/list");
  state.vpnList = Array.isArray(data) ? data : [];
  renderVpnBlock();
}

function renderVpnBlock() {
  const container = qs("vpn");
  container.innerHTML = "";

  if (state.vpnList.length === 0) {
    container.innerHTML = `
      <div class="card">
        <h3>VPN –Ω–µ —Å–æ–∑–¥–∞–Ω</h3>
        <p style="opacity:.7;margin:8px 0">
          –°–æ–∑–¥–∞–π—Ç–µ VPN –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        </p>
        <button class="primary-btn" id="create-vpn-btn">
          ‚ûï –°–æ–∑–¥–∞—Ç—å VPN
        </button>
      </div>
    `;

    qs("create-vpn-btn").onclick = createVpn;
    return;
  }

  state.vpnList.forEach(vpn => {
    const el = document.createElement("div");
    el.className = "card";

    el.innerHTML = `
      <h3>${vpn.email || vpn.name || "VPN"}</h3>
      <div class="row">
        <span>–°—Ç–∞—Ç—É—Å</span>
        <span class="status">
          ‚óè ${vpn.enabled ? "–ü–æ–¥–∫–ª—é—á–µ–Ω" : "–û—Ç–∫–ª—é—á–µ–Ω"}
        </span>
      </div>
      <button class="primary-btn">
        üîí –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É VPN
      </button>
    `;

    el.querySelector("button").onclick = () => {
      if (!vpn.vless_url) {
        showAlert("–°—Å—ã–ª–∫–∞ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞");
        return;
      }
      copyVpn(vpn.vless_url);
    };

    container.appendChild(el);
  });
}

async function createVpn() {
  try {
    await api("/api/vpn/create", { method: "POST" });
    showAlert("VPN —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω");
    await loadVpnList();
  } catch (e) {
    console.error(e);
    showAlert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è VPN");
  }
}

function copyVpn(url) {
  navigator.clipboard
    .writeText(url)
    .then(() => showAlert("VPN-—Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞"))
    .catch(() => showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å"));
}

/* ================== PAYMENTS (stub) ================== */
function createPayment() {
  showAlert(
    `–û–ø–ª–∞—Ç–∞\n` +
    `–ú–µ—Ç–æ–¥: ${state.paymentMethod.toUpperCase()}\n` +
    `–°—É–º–º–∞: ${state.amount} ‚ÇΩ`
  );
}

/* ================== UI ================== */
function bindUI() {
  // payment methods
  document.querySelectorAll(".pay-method").forEach(el => {
    el.onclick = () => {
      document.querySelectorAll(".pay-method")
        .forEach(p => p.classList.remove("active"));

      el.classList.add("active");
      state.paymentMethod =
        el.innerText.includes("–ö–∞—Ä—Ç–∞") ? "card" : "sbp";
    };
  });

  // amounts
  document.querySelectorAll(".amount").forEach(el => {
    el.onclick = () => {
      document.querySelectorAll(".amount")
        .forEach(a => a.classList.remove("active"));

      el.classList.add("active");
      state.amount = Number(el.innerText.replace(/\D/g, ""));
    };
  });
}

/* ================== NAVIGATION ================== */
function openTab(tab) {
  state.activeTab = tab;

  document.querySelectorAll(".view")
    .forEach(v => v.classList.remove("active"));

  qs(tab)?.classList.add("active");

  document.querySelectorAll(".footer-btn")
    .forEach(b => b.classList.remove("active"));

  if (tab === "topup") {
    document.querySelector(".footer-btn:nth-child(1)")?.classList.add("active");
  }

  if (tab === "help") {
    document.querySelector(".footer-btn:nth-child(3)")?.classList.add("active");
  }
}

/* ================== DRAWER ================== */
function openDrawer() {
  qs("drawer").classList.add("open");
  qs("overlay").classList.add("open");
}

function closeDrawer() {
  qs("drawer").classList.remove("open");
  qs("overlay").classList.remove("open");
}

/* ================== INIT ================== */
document.addEventListener("DOMContentLoaded", async () => {
  tg.ready();
  tg.expand();

  await waitForTelegramInit();

  try {
    await loadMe();
    await loadVpnList();
    bindUI();
    state.ready = true;
  } catch (e) {
    console.error(e);
    showAlert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
  }
});

/* ================== EXPOSE ================== */
window.openTab = openTab;
window.openDrawer = openDrawer;
window.closeDrawer = closeDrawer;
window.createVpn = createVpn;
window.copyVpn = copyVpn;
window.createPayment = createPayment;
</script>
</script>

</body>
</html>

