<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asburium VPN</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&family=Space+Grotesk:wght@400;600;700;800&display=swap" rel="stylesheet">

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="/static/main.css?v=20260206-1" />
</head>

<body>

<div id="overlay" class="drawer-overlay"></div>

<div id="drawer" class="drawer">
  <div class="user">
    <img id="avatar">
    <div>
      <strong id="username">User</strong><br>
      <small>ID: <span id="userid"></span></small>
    </div>
  </div>

  <div class="balance-card">
    <div>–ú–æ–π –±–∞–ª–∞–Ω—Å</div>
    <strong id="drawerBalance">üí∞ 0 ‚ÇΩ</strong>
    <button id="drawerTopupBtn">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
  </div>

  <div class="item">üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
  <div class="item">üéÅ –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ (+50 ‚ÇΩ)</div>
  <div class="item">üìò –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</div>
  <div class="item">üè∑ –ü—Ä–æ–º–æ–∫–æ–¥</div>
  <div class="item" style="color:#22c55e">üõü –ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
</div>

<header class="header">
  <div class="header-bar">
    <div id="menuBtn" class="menu-btn">‚ò∞</div>
    <div class="balance">
      üí∞ <span id="headerBalance">0 ‚ÇΩ</span>
      <div id="plusBtn" class="plus">+</div>
    </div>
  </div>
</header>

<main class="main">

  <!-- VPN -->
  <div id="vpn" class="view active">
    <div class="card">
      <h3>VPN</h3>
      <p style="opacity:.7;margin:8px 0">
        –°–æ–∑–¥–∞–π—Ç–µ VPN-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
      </p>
      <button class="primary-btn" id="createVpnBtn">
        ‚ûï –°–æ–∑–¥–∞—Ç—å VPN
      </button>
    </div>
    <div id="devicesList" class="devices-list"></div>
  </div>

  <!-- TOPUP -->
  <div id="topup" class="view">
    <div class="section hero-card reveal">
      <div class="section-kicker">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
      <h3 class="section-title">–ë—ã—Å—Ç—Ä–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h3>
      <p class="section-sub">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –∏ —É–¥–æ–±–Ω—ã–π —Ç–∞—Ä–∏—Ñ. –û–ø–ª–∞—Ç–∞ –∑–∞—â–∏—â–µ–Ω–∞.</p>
    </div>

    <div class="section split-card reveal delay-1">
      <div class="split-block">
        <div class="split-title">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</div>
        <div class="method-grid">
          <button class="method-card active">
            <div class="method-icon">‚ö°</div>
            <div class="method-text">
              <div class="method-name">–°–ë–ü</div>
              <div class="method-hint">–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ</div>
            </div>
          </button>
          <button class="method-card">
            <div class="method-icon">üí≥</div>
            <div class="method-text">
              <div class="method-name">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</div>
              <div class="method-hint">Visa / MasterCard</div>
            </div>
          </button>
        </div>
      </div>

      <div class="split-block">
        <div class="split-title">–¢–∞—Ä–∏—Ñ</div>
        <div class="plan-list">
          <button class="plan-card active">
            <div class="plan-main">150 ‚ÇΩ</div>
            <div class="plan-sub">1 –º–µ—Å—è—Ü –¥–æ—Å—Ç—É–ø–∞</div>
          </button>
          <button class="plan-card">
            <div class="plan-main">300 ‚ÇΩ</div>
            <div class="plan-sub">2 –º–µ—Å—è—Ü–∞ –¥–æ—Å—Ç—É–ø–∞</div>
          </button>
          <button class="plan-card">
            <div class="plan-main">450 ‚ÇΩ</div>
            <div class="plan-sub">3 –º–µ—Å—è—Ü–∞ –¥–æ—Å—Ç—É–ø–∞</div>
          </button>
        </div>
      </div>
    </div>

    <button class="primary-btn glow-btn reveal delay-2" id="payBtn">
      –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ
    </button>
  </div>

  <!-- HELP -->
  <div id="help" class="view">
    <div class="section hero-card reveal">
      <div class="section-kicker">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</div>
      <h3 class="section-title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∑–∞ 3 –º–∏–Ω—É—Ç—ã</h3>
      <p class="section-sub">–ù–∏–∂–µ ‚Äî –ø–æ–Ω—è—Ç–Ω—ã–µ —à–∞–≥–∏ –∏ –±—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è HAPP.</p>
    </div>

    <div class="section steps-card reveal delay-1">
      <div class="step">
        <div class="step-icon">‚ûï</div>
        <div class="step-body">
          <div class="step-title">–°–æ–∑–¥–∞–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</div>
          <div class="step-text">–ù–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–°–æ–∑–¥–∞—Ç—å VPN¬ª –∏ –ø–æ–ª—É—á–∏—Ç–µ –≤–∞—à—É —Å—Å—ã–ª–∫—É.</div>
        </div>
      </div>
      <div class="step">
        <div class="step-icon">‚¨áÔ∏è</div>
        <div class="step-body">
          <div class="step-title">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ HAPP</div>
          <div class="step-text">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ HAPP –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.</div>
        </div>
      </div>
      <div class="step">
        <div class="step-icon">üîó</div>
        <div class="step-body">
          <div class="step-title">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É</div>
          <div class="step-text">–í HAPP –≤—Å—Ç–∞–≤—å—Ç–µ VPN‚Äë—Å—Å—ã–ª–∫—É –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤–∫–ª—é—á–µ–Ω–∏—è.</div>
        </div>
      </div>
    </div>

    <div class="section store-card reveal delay-2">
      <div class="store-title">–°–∫–∞—á–∞—Ç—å HAPP</div>
      <div class="store-grid">
        <a class="store-btn" href="https://apps.apple.com/ru/app/happ-proxy-utility-plus/id6746188973" target="_blank" rel="noopener">
          <span class="store-icon">Ô£ø</span> App Store
        </a>
        <a class="store-btn" href="https://play.google.com/store/apps/details?id=com.happproxy" target="_blank" rel="noopener">
          <span class="store-icon">‚ñ∂</span> Play Market
        </a>
        <a class="store-btn" href="https://github.com/Happ-proxy/happ-desktop/releases/latest/download/setup-Happ.x64.exe" target="_blank" rel="noopener">
          <span class="store-icon">ü™ü</span> Windows
        </a>
        <a class="store-btn" href="https://play.google.com/store/apps/details?id=com.happproxy" target="_blank" rel="noopener">
          <span class="store-icon">üì∫</span> Android TV
        </a>
        <a class="store-btn" href="https://apps.apple.com/ru/app/happ-proxy-utility-plus/id6746188973" target="_blank" rel="noopener">
          <span class="store-icon">üçé</span> macOS
        </a>
      </div>
    </div>
  </div>

</main>

<footer class="footer">
  <div class="footer-btn" data-tab="topup">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</div>
  <div class="footer-core" data-tab="vpn">VPN</div>
  <div class="footer-btn" data-tab="help">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</div>
</footer>

<script>
/* ================= TELEGRAM ================= */
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

/* ================= USER ================= */
const user = tg.initDataUnsafe?.user;
if (user) {
  avatar.src = user.photo_url || "";
  username.textContent = user.first_name || "User";
  userid.textContent = user.id || "";
}

/* ================= API ================= */
function setBalance(balanceRub) {
  headerBalance.textContent = `${balanceRub} ‚ÇΩ`;
  drawerBalance.textContent = `üí∞ ${balanceRub} ‚ÇΩ`;
}

async function loadMe() {
  const res = await fetch("/api/me", {
    headers: { "X-Telegram-Init-Data": tg.initData }
  });
  if (!res.ok) throw new Error(await res.text());
  const me = await res.json();
  setBalance(me.balance_rub ?? 0);
}

function escapeHtml(str) {
  return String(str ?? "").replace(/[&<>"']/g, (ch) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    "\"": "&quot;",
    "'": "&#039;",
  }[ch]));
}

async function copyText(text) {
  try {
    await navigator.clipboard.writeText(text);
    return true;
  } catch {
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.opacity = "0";
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try {
      document.execCommand("copy");
      return true;
    } catch {
      return false;
    } finally {
      document.body.removeChild(ta);
    }
  }
}

async function loadDevices() {
  const res = await fetch("/api/vpn/list", {
    headers: { "X-Telegram-Init-Data": tg.initData }
  });
  if (!res.ok) throw new Error(await res.text());
  const data = await res.json();
  const items = data.items || [];

  if (!items.length) {
    devicesList.innerHTML = `<div class="devices-empty">–£—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>`;
    return;
  }

  devicesList.innerHTML = items.map(d => {
    const statusText = d.enabled ? "–ê–∫—Ç–∏–≤–µ–Ω" : "–û—Ç–∫–ª—é—á—ë–Ω";
    const statusClass = d.enabled ? "active" : "inactive";
    const fallbackIndex = d.device_index ?? d.id;
    const name = d.name ? escapeHtml(d.name) : `–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ${fallbackIndex}`;
    const price = `${d.price_per_day ?? 0} ‚ÇΩ / –¥–µ–Ω—å`;
    return `
      <div class="device-card">
        <div class="device-head">
          <div class="device-title">${name}</div>
          <button class="device-delete" data-delete="${d.id}" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
        </div>
        <div class="device-info">
          <div class="device-info-row">
            <div class="device-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</div>
            <div class="device-value">${price}</div>
          </div>
          <div class="device-info-row">
            <div class="device-label">–¢—Ä–∞—Ñ–∏–∫</div>
            <div class="device-value">‚àû</div>
          </div>
          <div class="device-info-row">
            <div class="device-label">–°—Ç–∞—Ç—É—Å</div>
            <div class="device-value device-status ${statusClass}">‚óè ${statusText}</div>
          </div>
        </div>
        <button class="device-copy" data-copy="${escapeHtml(d.vless_url)}">üîí –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å VPN‚Äë—Å—Å—ã–ª–∫—É</button>
        <div class="device-hint">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä</div>
      </div>
    `;
  }).join("");

  devicesList.querySelectorAll("[data-copy]").forEach(btn => {
    btn.onclick = async () => {
      const url = btn.getAttribute("data-copy") || "";
      const ok = await copyText(url);
      tg.showAlert(ok ? "–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞" : "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É");
    };
  });

  devicesList.querySelectorAll("[data-delete]").forEach(btn => {
    btn.onclick = async (e) => {
      e.preventDefault();
      e.stopPropagation();
      const id = Number(btn.getAttribute("data-delete"));
      if (!id) return;
      const ok = window.confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ?");
      if (!ok) return;
      try {
        const res = await fetch("/api/vpn/delete", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Telegram-Init-Data": tg.initData,
          },
          body: JSON.stringify({ device_id: id }),
        });
        if (!res.ok) throw new Error(await res.text());
        tg.showAlert("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ");
        await loadDevices();
      } catch (err) {
        console.error(err);
        tg.showAlert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
      }
    };
  });
}

async function createVPN() {
  try {
    const name = window.prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä iPhone)", "") || null;
    const res = await fetch("/api/vpn/create", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Telegram-Init-Data": tg.initData,
      },
      body: JSON.stringify({ name }),
    });

    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();

    const copied = await copyText(data.vless_url);
    tg.showAlert(copied ? "VPN —Å–æ–∑–¥–∞–Ω. –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞" : "VPN —Å–æ–∑–¥–∞–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è —Å—Å—ã–ª–∫–∏");
    console.log("VLESS:", data.vless_url);
    await loadMe();
    await loadDevices();

  } catch (e) {
    console.error(e);
    tg.showAlert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è VPN");
  }
}

/* ================= NAV ================= */
function openTab(tab) {
  document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
  document.getElementById(tab).classList.add("active");

  document.querySelectorAll(".footer-btn").forEach(b => b.classList.remove("active"));
  document.querySelector(`[data-tab="${tab}"]`)?.classList.add("active");
}

/* ================= EVENTS ================= */
menuBtn.onclick = () => {
  drawer.classList.add("open");
  overlay.classList.add("open");
};

overlay.onclick = () => {
  drawer.classList.remove("open");
  overlay.classList.remove("open");
};

plusBtn.onclick = () => openTab("topup");

drawerTopupBtn.onclick = () => {
  drawer.classList.remove("open");
  overlay.classList.remove("open");
  openTab("topup");
};

document.querySelectorAll("[data-tab]").forEach(btn => {
  btn.onclick = () => openTab(btn.dataset.tab);
});

document.getElementById("createVpnBtn").onclick = createVPN;

payBtn.onclick = () => tg.showAlert("–ü–µ—Ä–µ—Ö–æ–¥ –∫ –æ–ø–ª–∞—Ç–µ");

// Initial load
(async () => {
  try {
    await loadMe();
    await loadDevices();
  } catch (e) {
    console.error(e);
  }
})();
</script>

</body>
</html>
