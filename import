import httpx
from app.config import settings


class XUIClient:
    def __init__(self):
        # base_url УЖЕ С WebBasePath
        self.base_url = settings.XUI_BASE_URL.rstrip("/")
        self.username = settings.XUI_USERNAME
        self.password = settings.XUI_PASSWORD
        self.inbound_id = settings.XUI_INBOUND_ID
        self.client: httpx.AsyncClient | None = None

    async def _login(self):
        self.client = httpx.AsyncClient(
            verify=False,
            timeout=15,
            base_url=self.base_url,
        )

        r = await self.client.post(
            "/login",
            data={
                "username": self.username,
                "password": self.password,
            },
        )
        r.raise_for_status()

    async def close(self):
        if self.client:
            await self.client.aclose()

    async def create_client(self, client_id: str, email: str) -> str:
        if not self.client:
            await self._login()

        payload = {
            "id": self.inbound_id,
            "client": {
                "id": client_id,
                "email": email,
                "enable": True,
            },
        }

        r = await self.client.post(
            "/panel/api/inbounds/addClient",
            json=payload,
        )
        r.raise_for_status()

        return f"{self.base_url}/sub/{client_id}"

    async def disable_client(self, client_id: str):
        if not self.client:
            await self._login()

        r = await self.client.post(
            "/panel/api/inbounds/updateClient",
            json={
                "id": self.inbound_id,
                "client": {
                    "id": client_id,
                    "enable": False,
                },
            },
        )
        r.raise_for_status()

