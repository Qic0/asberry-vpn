<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asburium VPN</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

body {
  background: #05070f;
  color: #fff;
  height: 100vh;
  overflow: hidden;
}

/* ================= HEADER ================= */
.header {
  height: 90px;
  background: url("/static/robot_in_space.png") center -55px / cover no-repeat;
}

.header-bar {
  height: 56px;
  padding: 0 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.menu-btn {
  font-size: 26px;
  cursor: pointer;
}

.balance {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  background: rgba(20,25,40,.95);
  border-radius: 999px;
  box-shadow: 0 0 18px rgba(255,200,0,.45);
}

.balance span {
  color: #ffd54a;
  font-weight: 600;
}

.balance .plus {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: #3b82f6;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  cursor: pointer;
}

/* ================= OVERLAY ================= */
.drawer-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  opacity: 0;
  pointer-events: none;
  transition: .3s;
  z-index: 9;
}
.drawer-overlay.open {
  opacity: 1;
  pointer-events: all;
}

/* ================= DRAWER ================= */
.drawer {
  position: fixed;
  top: 0;
  left: -65%;
  width: 65%;
  height: 100%;
  background: linear-gradient(180deg, #0b1020, #05070f);
  padding: 20px;
  transition: .3s;
  z-index: 10;
}
.drawer.open { left: 0; }

.drawer .user {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}
.drawer .user img {
  width: 48px;
  height: 48px;
  border-radius: 50%;
}

.drawer .balance-card {
  background: #0f172a;
  border-radius: 16px;
  padding: 14px;
  margin-bottom: 18px;
}
.drawer .balance-card strong {
  font-size: 20px;
}
.drawer .balance-card button {
  margin-top: 10px;
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: none;
  background: #3b82f6;
  color: #fff;
  font-weight: 600;
  cursor: pointer;
}
.drawer .item {
  padding: 14px 0;
  border-bottom: 1px solid rgba(255,255,255,.08);
  cursor: pointer;
}

/* ================= MAIN ================= */
.main {
  position: absolute;
  top: 90px;
  bottom: 92px;
  left: 0;
  right: 0;
  overflow-y: auto;
  padding: 16px;
}

.view { display: none; }
.view.active { display: block; }

/* ================= CARD ================= */
.card {
  background: linear-gradient(180deg, #0e162a, #070b17);
  border-radius: 22px;
  padding: 18px;
  margin-bottom: 16px;
}

/* ================= VPN ================= */
.row {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid rgba(255,255,255,.08);
}
.row:last-child { border-bottom: none; }
.status { color: #22c55e; }

.primary-btn {
  margin-top: 14px;
  width: 100%;
  padding: 14px;
  border-radius: 14px;
  border: none;
  background: #3b82f6;
  color: #fff;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
}

/* ================= TOPUP ================= */
.topup-title {
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 4px;
}
.topup-sub {
  opacity: .7;
  margin-bottom: 14px;
}

.pay-methods {
  display: flex;
  gap: 12px;
  margin-bottom: 14px;
}
.pay-method {
  flex: 1;
  background: #0f172a;
  border-radius: 16px;
  padding: 14px;
  text-align: center;
  border: 2px solid transparent;
  cursor: pointer;
}
.pay-method.active {
  border-color: #3b82f6;
}
.pay-method span {
  display: block;
  margin-top: 6px;
  font-weight: 600;
}

.amounts-title {
  font-weight: 600;
  margin-bottom: 8px;
}

.amount {
  background: #0f172a;
  border-radius: 16px;
  padding: 14px;
  margin-bottom: 10px;
  cursor: pointer;
}
.amount.active {
  outline: 2px solid #3b82f6;
}
.amount strong {
  font-size: 18px;
}
.amount small {
  display: block;
  opacity: .7;
  margin-top: 4px;
}

/* ================= —Ñ—É—Ç–µ—Ä –ù–û–í–´–ô ================= */
.footer {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 92px;
  background: rgba(10,14,30,.75);
  backdrop-filter: blur(18px);
  border-top: 1px solid rgba(255,255,255,.06);
  display: flex;
  align-items: center;
  justify-content: space-around;
  z-index: 5;
}

.footer-btn {
  flex: 1;
  text-align: center;
  color: #8b93b7;
  font-size: 12px;
  cursor: pointer;
  transition: .2s;
}
.footer-btn span {
  display: block;
  font-size: 20px;
  margin-bottom: 4px;
}
.footer-btn.active {
  color: #3b82f6;
}

.footer-core {
  width: 66px;
  height: 66px;
  border-radius: 50%;
  background: radial-gradient(circle at top, #60a5fa, #2563eb);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-weight: 700;
  box-shadow:
    0 0 18px rgba(59,130,246,.6),
    0 0 36px rgba(59,130,246,.35);
  transform: translateY(-14px);
  cursor: pointer;
}
</style>
</head>

<body>

<div class="drawer-overlay" id="overlay" onclick="closeDrawer()"></div>

<div class="drawer" id="drawer">
  <div class="user">
    <img id="avatar">
    <div>
      <strong id="username">User</strong><br>
      <small>ID: <span id="userid"></span></small>
    </div>
  </div>

  <div class="balance-card">
    <div>–ú–æ–π –±–∞–ª–∞–Ω—Å</div>
    <strong>üí∞ 0 ‚ÇΩ</strong>
    <button onclick="openTab('topup'); closeDrawer()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
  </div>

  <div class="item">üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
  <div class="item">üéÅ –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ (+50 ‚ÇΩ)</div>
  <div class="item">üìò –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</div>
  <div class="item">üè∑ –ü—Ä–æ–º–æ–∫–æ–¥</div>
  <div class="item" style="color:#22c55e">üõü –ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
</div>

<header class="header">
  <div class="header-bar">
    <div class="menu-btn" onclick="openDrawer()">‚ò∞</div>
    <div class="balance">
      üí∞ <span>50 ‚ÇΩ</span>
      <div class="plus" onclick="openTab('topup')">+</div>
    </div>
  </div>
</header>

<main class="main">

  <div id="vpn" class="view active">
   <div class="card" id="vpnCard">
    </div>
  </div>

  <div id="topup" class="view">
    <div class="card">
      <div class="topup-title">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</div>
      <div class="topup-sub">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –∏ —Å—É–º–º—É</div>

      <div class="pay-methods">
        <div class="pay-method active">üí∞<span>–°–ë–ü</span></div>
        <div class="pay-method">üí≥<span>–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</span></div>
      </div>

      <div class="amounts-title">–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</div>

      <div class="amount active">
        <strong>150 ‚ÇΩ</strong>
        <small>–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ 1 –º–µ—Å—è—Ü</small>
      </div>
      <div class="amount">
        <strong>300 ‚ÇΩ</strong>
        <small>–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ 2 –º–µ—Å—è—Ü–∞</small>
      </div>
      <div class="amount">
        <strong>450 ‚ÇΩ</strong>
        <small>–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ 3 –º–µ—Å—è—Ü–∞</small>
      </div>

<button class="primary-btn" onclick="createPayment()">
  –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ
</button>
    </div>
  </div>

  <div id="help" class="view">
    <div class="card">
      <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</h3>
      <p>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é VPN</p>
    </div>
  </div>

</main>

<footer class="footer">
  <div class="footer-btn active" onclick="openTab('topup')">
    <span>üí∞</span>–ü–æ–ø–æ–ª–Ω–∏—Ç—å
  </div>

  <div class="footer-core" onclick="openTab('vpn')">
    VPN
  </div>

  <div class="footer-btn" onclick="openTab('help')">
    <span>üìò</span>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
  </div>
</footer>

<script>
/* ================== TELEGRAM ================== */
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

/* ================== STATE ================== */
const state = {
  user: null,
  activeTab: 'vpn',
  vpnCreated: false,
  paymentMethod: 'sbp',
  amount: 150,
};

/* ================== HELPERS ================== */
function qs(id) {
  return document.getElementById(id);
}

function qsa(sel) {
  return document.querySelectorAll(sel);
}

function show(el) {
  el.style.display = 'block';
}

function hide(el) {
  el.style.display = 'none';
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    tg.showToast?.({ text: '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞' }) ||
    alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
  });
}

/* ================== INIT ================== */
document.addEventListener('DOMContentLoaded', () => {
  initAuth();
  initUI();
});

/* ================== AUTH ================== */
async function initAuth() {
  try {
    const res = await fetch('/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ initData: tg.initData })
    });

    if (!res.ok) throw new Error('Auth failed');

    state.user = await res.json();
    state.vpnCreated = Boolean(state.user.xui_client_id);

    renderUser();
    renderVPN();
  } catch (e) {
    console.error(e);
    tg.showAlert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
  }
}

/* ================== RENDER USER ================== */
function renderUser() {
  qs('username').innerText =
    tg.initDataUnsafe.user?.first_name || 'User';

  qs('userid').innerText =
    state.user.telegram_id || '';

  qs('avatar').src =
    tg.initDataUnsafe.user?.photo_url || '';

  // –±–∞–ª–∞–Ω—Å (–≤ —Ö–µ–¥–µ—Ä–µ –∏ –¥—Ä–æ–≤–µ—Ä–µ)
  qsa('.balance span').forEach(el => {
    el.innerText = `${state.user.balance} ‚ÇΩ`;
  });

  const drawerBalance = document.querySelector('.balance-card strong');
  if (drawerBalance) {
    drawerBalance.innerText = `üí∞ ${state.user.balance} ‚ÇΩ`;
  }
}

/* ================== RENDER VPN ================== */
function renderVPN() {
  const vpnView = qs('vpn');
  if (!vpnView) return;

  // –µ—Å–ª–∏ VPN –Ω–µ —Å–æ–∑–¥–∞–Ω
  if (!state.vpnCreated) {
    vpnView.innerHTML = `
      <div class="card">
        <h3>VPN –Ω–µ —Å–æ–∑–¥–∞–Ω</h3>
        <p style="opacity:.7;margin-top:8px">
          –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å VPN
        </p>
        <button class="primary-btn" onclick="createVPN()">
          ‚ûï –°–æ–∑–¥–∞—Ç—å VPN
        </button>
      </div>
    `;
    return;
  }

  // VPN —Å–æ–∑–¥–∞–Ω
  vpnView.innerHTML = `
    <div class="card">
      <h3>Asberry-vpn</h3>

      <div class="row">
        <span>ID –∫–ª–∏–µ–Ω—Ç–∞</span>
        <strong>${state.user.telegram_id}</strong>
      </div>

      <div class="row">
        <span>–°—Ç–æ–∏–º–æ—Å—Ç—å</span>
        <strong>5 ‚ÇΩ / –¥–µ–Ω—å</strong>
      </div>

      <div class="row">
        <span>–¢—Ä–∞—Ñ–∏–∫</span>
        <strong>–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π</strong>
      </div>

      <div class="row">
        <span>–°—Ç–∞—Ç—É—Å</span>
        <span class="status">
          ‚óè ${state.user.subscription_active ? '–ü–æ–¥–∫–ª—é—á–µ–Ω' : '–û—Ç–∫–ª—é—á—ë–Ω'}
        </span>
      </div>

      <button class="primary-btn" onclick="copyVPN()">
        üîí –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É VPN
      </button>
    </div>
  `;
}

/* ================== CREATE VPN ================== */
async function createVPN() {
  try {
    const res = await fetch('/vpn/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ initData: tg.initData })
    });

    if (!res.ok) throw new Error('VPN create error');

    const data = await res.json();
    state.vpnCreated = true;
    state.user.subscription_url = data.subscription_url;
    state.user.subscription_active = data.subscription_active;

    renderVPN();
    tg.showAlert('VPN —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω');
  } catch (e) {
    console.error(e);
    tg.showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è VPN');
  }
}

/* ================== COPY VPN ================== */
function copyVPN() {
  if (!state.user.subscription_url) {
    tg.showAlert('–°—Å—ã–ª–∫–∞ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞');
    return;
  }
  copyToClipboard(state.user.subscription_url);
}

/* ================== UI ================== */
function initUI() {
  // overlay
  qs('overlay').addEventListener('click', closeDrawer);

  // –º–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã
  qsa('.pay-method').forEach(el => {
    el.addEventListener('click', () => {
      qsa('.pay-method').forEach(p => p.classList.remove('active'));
      el.classList.add('active');
      state.paymentMethod =
        el.innerText.includes('–ö–∞—Ä—Ç–∞') ? 'card' : 'sbp';
    });
  });

  // —Å—É–º–º—ã
  qsa('.amount').forEach(el => {
    el.addEventListener('click', () => {
      qsa('.amount').forEach(a => a.classList.remove('active'));
      el.classList.add('active');
      state.amount = parseInt(el.innerText);
    });
  });
}

/* ================== NAVIGATION ================== */
function openTab(tab) {
  state.activeTab = tab;

  qsa('.view').forEach(v => v.classList.remove('active'));
  qs(tab).classList.add('active');

  qsa('.footer-btn').forEach(b => b.classList.remove('active'));
  if (tab === 'topup') qsa('.footer-btn')[0]?.classList.add('active');
  if (tab === 'help') qsa('.footer-btn')[1]?.classList.add('active');
}

/* ================== DRAWER ================== */
function openDrawer() {
  qs('drawer').classList.add('open');
  qs('overlay').classList.add('open');
}

function closeDrawer() {
  qs('drawer').classList.remove('open');
  qs('overlay').classList.remove('open');
}

/* ================== PAYMENTS (–∑–∞–≥–ª—É—à–∫–∞) ================== */
async function createPayment() {
  tg.showAlert(
    `–û–ø–ª–∞—Ç–∞:\n${state.amount} ‚ÇΩ\n–ú–µ—Ç–æ–¥: ${
      state.paymentMethod === 'sbp' ? '–°–ë–ü' : '–ö–∞—Ä—Ç–∞'
    }`
  );
}

/* ================== EXPORT ================== */
window.openDrawer = openDrawer;
window.closeDrawer = closeDrawer;
window.openTab = openTab;
window.createVPN = createVPN;
window.copyVPN = copyVPN;
window.createPayment = createPayment;
</script>

</body>
</html>

